<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Forklift Game</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a" />

  <style>
    :root { --bg:#0f172a; --panel:#111827; --line:#1f2937; --text:#e5e7eb; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 10px 20px rgba(0,0,0,.2)}
    h1{margin:0 0 8px;line-height:1.05}
    #game{position:relative;width:100%;height:auto;aspect-ratio:800/500;margin:8px auto;background:#0f1a2a;border:2px solid #6b7280;border-radius:12px;overflow:hidden;touch-action:none}
    .wall{position:absolute;background:#0b1220}
    .forklift{position:absolute;background:#facc15;border-radius:4px;box-shadow:0 2px 8px rgba(0,0,0,.4);transform-origin:center}
    .pallet{position:absolute;background:#92400e;border:2px solid #b45309;border-radius:4px;box-shadow:0 2px 6px rgba(0,0,0,.3)}
    .row{display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid #374151;background:#1f2937;color:var(--text);cursor:pointer}
    .hud{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    /* Mobile touch controls */
    .controls{display:none;margin-top:12px;gap:8px;justify-content:center}
    .pad{width:70px;height:70px;border-radius:12px;border:1px solid #374151;background:#1f2937;display:flex;align-items:center;justify-content:center;font-weight:700;user-select:none}
    @media (max-width: 820px){ .controls{display:flex} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <h1>Warehouse Forklift Driving Game</h1>
        <div class="hud">
          <div><strong>Score:</strong> <span id="score">0</span>/<span id="total">0</span></div>
          <button id="reset" class="btn">Reset</button>
        </div>
      </div>
      <p style="margin:8px 0 12px">Keyboard: Arrow keys. On phone: use the pads below.</p>
      <div id="game" aria-label="Forklift game area"></div>
      <div class="controls">
        <div class="pad" data-pad="left">⟵</div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <div class="pad" data-pad="up">⟰</div>
          <div class="pad" data-pad="down">⟱</div>
        </div>
        <div class="pad" data-pad="right">⟶</div>
      </div>
    </div>
  </div>

  <script>
    // --- Base (unscaled) world units ---
    const BASE_W = 800, BASE_H = 500;
    const LIFT_W = 40, LIFT_H = 20;
    const SPEED = 4, TURN = 4;
    const PALLET_RADIUS = 30;

    // scale = how many screen pixels per base unit
    let scale = 1;

    const game = document.getElementById('game');

    // UI
    const scoreEl = document.getElementById('score');
    const totalEl = document.getElementById('total');

    // State (in base units)
    let forklift = { x: 80, y: 80, angle: 0 };
    const pallets = [
      { id:1, x:200, y:150, collected:false },
      { id:2, x:350, y:300, collected:false },
      { id:3, x:520, y:220, collected:false },
      { id:4, x:700, y:120, collected:false },
      { id:5, x:140, y:380, collected:false },
    ];
    totalEl.textContent = pallets.length;

    // Elements
    const liftEl = document.createElement('div');
    liftEl.className = 'forklift';
    game.appendChild(liftEl);

    const palletEls = new Map();

    // Walls (use percentages so they scale automatically)
    const walls = [
      {left:0, top:0, width:'100%', height:'10px'},
      {left:0, bottom:0, width:'100%', height:'10px'},
      {top:0, left:0, width:'10px', height:'100%'},
      {top:0, right:0, width:'10px', height:'100%'}
    ];
    walls.forEach(s => { const w = document.createElement('div'); w.className='wall'; Object.assign(w.style, s); game.appendChild(w); });

    // Input
    const keys = { left:false, right:false, up:false, down:false };
    window.addEventListener('keydown', e => {
      if(e.key==='ArrowLeft')  keys.left = true;
      if(e.key==='ArrowRight') keys.right = true;
      if(e.key==='ArrowUp')    keys.up = true;
      if(e.key==='ArrowDown')  keys.down = true;
    });
    window.addEventListener('keyup', e => {
      if(e.key==='ArrowLeft')  keys.left = false;
      if(e.key==='ArrowRight') keys.right = false;
      if(e.key==='ArrowUp')    keys.up = false;
      if(e.key==='ArrowDown')  keys.down = false;
    });

    // Touch pads
    const activePads = new Set();
    function padSet(dir, on){ on ? activePads.add(dir) : activePads.delete(dir); syncPads(); }
    function syncPads(){ keys.left=activePads.has('left'); keys.right=activePads.has('right'); keys.up=activePads.has('up'); keys.down=activePads.has('down'); }
    function wirePad(el, dir){
      const start = (e)=>{ e.preventDefault(); padSet(dir,true); };
      const end   = (e)=>{ e.preventDefault(); padSet(dir,false); };
      el.addEventListener('pointerdown', start);
      el.addEventListener('pointerup', end);
      el.addEventListener('pointercancel', end);
      el.addEventListener('pointerleave', end);
    }
    document.querySelectorAll('[data-pad]').forEach(el => wirePad(el, el.dataset.pad));

    // Responsive scaling
    function updateScale(){
      // Fit to container width (game div) while preserving 800x500 aspect
      const cw = game.clientWidth || window.innerWidth * 0.95;
      scale = cw / BASE_W;
      renderStatic();
    }
    window.addEventListener('resize', updateScale);
    new ResizeObserver(updateScale).observe(game);
    updateScale();

    // Helpers
    const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

    // Render pallets & static element sizes at current scale
    function renderStatic(){
      // Pallets
      pallets.forEach(p=>{
        let el = palletEls.get(p.id);
        if(p.collected){ if(el){ el.remove(); palletEls.delete(p.id); } return; }
        if(!el){ el = document.createElement('div'); el.className='pallet'; palletEls.set(p.id, el); game.appendChild(el); }
        el.style.width  = (30*scale) + 'px';
        el.style.height = (30*scale) + 'px';
        el.style.left   = (p.x*scale) + 'px';
        el.style.top    = (p.y*scale) + 'px';
      });

      // Forklift size (position updated every frame)
      liftEl.style.width  = (LIFT_W*scale) + 'px';
      liftEl.style.height = (LIFT_H*scale) + 'px';
    }

    // Main loop
    function tick(){
      // Move in base units
      if(keys.left)  forklift.angle -= TURN;
      if(keys.right) forklift.angle += TURN;
      const rad = forklift.angle * Math.PI/180;
      if(keys.up){   forklift.x += SPEED*Math.cos(rad); forklift.y += SPEED*Math.sin(rad); }
      if(keys.down){ forklift.x -= SPEED*Math.cos(rad); forklift.y -= SPEED*Math.sin(rad); }

      // Clamp to base bounds (subtract forklift size)
      forklift.x = clamp(forklift.x, 10, BASE_W - LIFT_W - 10);
      forklift.y = clamp(forklift.y, 10, BASE_H - LIFT_H - 10);

      // Collect pallets (base distances)
      let changed = false;
      for(const p of pallets){
        if(!p.collected){
          const dx = p.x - forklift.x, dy = p.y - forklift.y;
          if(Math.hypot(dx,dy) < PALLET_RADIUS){ p.collected = true; changed = true; }
        }
      }
      if(changed){ scoreEl.textContent = pallets.filter(p=>p.collected).length; renderStatic(); }

      // Render forklift in scaled pixels
      liftEl.style.left = (forklift.x*scale) + 'px';
      liftEl.style.top  = (forklift.y*scale) + 'px';
      liftEl.style.transform = `rotate(${forklift.angle}deg)`;

      requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);

    // Reset
    document.getElementById('reset').onclick = ()=>{
      forklift = { x:80, y:80, angle:0 };
      pallets.forEach(p=>p.collected=false);
      scoreEl.textContent = 0;
      renderStatic();
    };

    // PWA service worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js', { scope: './' }).catch(()=>{});
      });
    }
  </script>
</body>
</html>